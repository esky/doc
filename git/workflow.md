# git项目工作流程

## 前言
本工作流程基于第一版工作流程创建，并对实际使用中遇到的问题进行了处理，调整了流程中的一个重要环节，并明确了QA在整个流程控制中的主导地位。

## 流程示意图
![git工作流程示意图][1]

## 基本原则

1. `master`分支仅仅接受以下两个途径的代码合并
    + 已经发布上线确认无误的 `release` 分支
    + 已经发布上线确认无误的 `bugfix` 分支
2. 禁止在 `master` 上使用上述分支合并以外的任何操作
3. 开发分支从 `master` 上拉取[注1]，测试分支从 `develop` 上拉取
4. 所有在线发布（含在线确认）均从 `release`/`bugfix` 发布，禁止发布其他任何分支

> 注1：当前要修改的内容强制依赖一个正在开发阶段或测试阶段的分支，此时可以从当前分支创建新分支进行开发，这种情况称之为“线性依赖”

## 代码流程

### 开发阶段
- [开发] 从`master`分支拉取功能开发分支 `f_<功能名>` 并进行开发
- [开发] 在收到`master`变更通知（popo）时，同步（合并）`master`代码到本地开发分支
- [开发] 开发基本完毕，前后端自行联调
- [开发] 提测
    + 注明前后端的开发分支 `f_<功能名>`
    + 如果当前分支存在线性依赖，需要在提测说明中备注清楚所依赖的分支以及功能

### 测试阶段1
- [QA] 基于`f_<功能名>`分支[注1]合并到相应的`test`分支（每个项目可能存在多个test分支：`test1`,`test2`以此类推）
- [QA] 每天同步（合并）一次`develop`分支到自己测试的`test`分支
- [QA] 测试过程中发现bug或代码冲突，通知开发进行修复
- [开发] 收到bug通知后，在`f_<功能名>`上提交bug修复，完成并自测后通知QA验收
- [QA] 收到开发的修复通知后，QA重复上述步骤。以上修复bug过程可多次重复，直至功能完成并验收成功

> 注1：QA可以根据实际情况决定是直接使用开发分支，还是利用tag锁定版本后进行合并

### 测试阶段2
- [QA] 将首轮验收完毕的开发分支[注1]合并到 `develop`进行回归测试
- [QA] 发现bug或代码冲突，通知开发进行修复
- [开发] 收到bug通知后，在`f_<功能名>`上提交bug修复，完成并自测后，通知QA验收
- [QA] 收到开发的修复通知后，QA重复上述步骤。以上修复过程可多次重复，直至验收成功

> 注1：QA可以根据实际情况决定是直接使用开发分支，还是利用tag锁定版本后进行合并

### 发布阶段
- [QA] 基于`master`创建发布分支`release_<描述>`
- [开发]同步（合并）`master`到开发分支，进行发布前的代码冲突确认
- [QA] 将验收完毕需要发布的所有开发分支合并到`release_<描述>`
- [QA] 将`release_<描述>`发布到在线确认进行确认
- [QA、开发] 到在线确认进行功能以及代码验证
- [开发] 确认中发现问题，评估修改风险：
    - 若风险不可以接受，则延迟该功能发布，`release_<描述>`作废删除；
    - 若风险可以接受，则及时修改`f_<功能名>`并通知QA合并
- [QA] 收到开发修复通知后，合并`f_<功能名>`分支[注1]到`release_<描述>`上
- [QA] 重发在线确认。以上确认和修复步骤可以多次进行，直到功能以及代码确认完毕为止
- [QA] 发送在线发布申请邮件，等待将`release_<描述>`发布在线
- [QA] 发布在线后，通知开发、产品进行确认
    - 确认无误后，进入release收尾阶段
    - 确认有误，进入回滚阶段或重复发布阶段

> 注1：QA可以根据实际情况决定是直接使用开发分支，还是利用tag锁定版本后进行合并

### release收尾阶段
- [QA] 发布在线并确认无误后
    + 以`master`为参考，创建tag备份分支`master_backup_<日期或描述>`
    + 将`release_<描述>`合并到`master`分支以及`develop`分支
- [QA] 删除`release_<描述>`分支，以及相关临时分支。该删除操作，可以每周固定时间统一进行

### 回滚阶段
- [QA] 当发布在线后，若发现问题，评估问题风险，若风险较高，则进行回滚操作，方法有二：
    -  利用 OPS 系统的回滚操作进行回滚
    -  从`master`新拉`release_revert`分支进行发布（发布流程见上）
- [QA] 回滚发布后进行再次确认
    - 确认无误后，结束
    - 确认有误后，必须利用 OPS 重复回滚阶段或进入bugfix阶段

### bugfix阶段
- [QA] 发现线上问题后，评估问题风险，若风险较低或不能回滚，则进入 bugfix阶段
- [开发] 基于`master`创建`bugfix_<描述>`分支
- [开发] 提交修复代码，完成并自测后，通知QA验收
- [QA] 收到开发通知后，将`bugfix_<描述>`发布到在线确认进行验收
    - 若验收通过，则进入下一步
    - 若验收不通过，则通知开发再次修改
- [QA] 发送在线发布申请邮件，等待将`bugfix_<描述>`发布在线
- [QA] 发布在线后，通知开发、产品进行确认
    - 确认无误后进入bugfix收尾阶段
    - 确认有误，进入回滚阶段或重复bugfix阶段

### bugfix收尾阶段
- [QA] 当在线发布确认无误后
    + 以`master`为参考，创建tag备份分支`master_backup_<日期或描述>`
    + 将`bugfix_<描述>`合并到`master`以及`develop`分支
- [QA] 删除`bugfix_<描述>`分支。该删除操作，可以每周固定时间统一进行


  [1]: http://pimg1.126.net/nfop/lede/git-work-flow.png